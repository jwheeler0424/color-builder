<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chroma — Color Toolkit</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0a;--s1:#111;--s2:#181818;--s3:#202020;
  --b1:#222;--b2:#333;
  --t1:#f0f0f0;--t2:#aaa;--t3:#666;
  --acc:#e8ff00;--danger:#ff4455;
  --r:2px;--fd:'Syne',sans-serif;--fm:'Space Mono',monospace;
  --ease:cubic-bezier(.16,1,.3,1);--pw:320px;
}
html,body{height:100%;background:var(--bg);color:var(--t1);font-family:var(--fm);font-size:13px;line-height:1.5;-webkit-font-smoothing:antialiased;}
.app{display:flex;flex-direction:column;height:100vh;overflow:hidden;}
.hdr{display:flex;align-items:center;padding:0 16px;height:48px;border-bottom:1px solid var(--b1);background:var(--s1);gap:10px;flex-shrink:0;}
.brand{font-family:var(--fd);font-size:16px;font-weight:800;letter-spacing:-.5px;flex-shrink:0;}
.brand sup{font-size:9px;color:var(--t3);font-weight:400;}
.nav{display:flex;gap:1px;flex:1;overflow-x:auto;scrollbar-width:none;}
.nav::-webkit-scrollbar{display:none;}
.nb{padding:4px 10px;border-radius:var(--r);border:1px solid transparent;background:transparent;color:var(--t3);font-family:var(--fm);font-size:11px;cursor:pointer;letter-spacing:.04em;white-space:nowrap;transition:color 100ms;}
.nb:hover{color:var(--t1);}
.nb.on{background:var(--s3);color:var(--t1);border-color:var(--b2);}
.hbtns{display:flex;gap:5px;flex-shrink:0;}
.panel{width:var(--pw);background:var(--s1);border-left:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;}
.pscroll{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--b2) transparent;}
.psec{padding:14px 16px;border-bottom:1px solid var(--b1);}
.slabel{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--t3);margin-bottom:10px;font-family:var(--fd);font-weight:600;}
.genbar{padding:12px 16px;border-top:1px solid var(--b1);background:var(--s1);flex-shrink:0;}
.genrow{display:flex;gap:6px;}
.genrow .bp{flex:1;padding:10px;}
.hint{font-size:10px;color:var(--t3);text-align:center;margin-top:6px;}
kbd{display:inline-block;padding:1px 4px;border:1px solid var(--b2);border-radius:2px;font-size:10px;color:var(--t3);}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:4px;padding:6px 11px;border-radius:var(--r);font-family:var(--fm);font-size:11px;font-weight:700;cursor:pointer;border:1px solid transparent;letter-spacing:.04em;white-space:nowrap;transition:background 100ms,color 100ms,border-color 100ms;user-select:none;}
.bp{background:var(--acc);color:#000;border-color:var(--acc);}
.bp:hover{background:#fff;border-color:#fff;}
.bg{background:transparent;color:var(--t2);border-color:var(--b1);}
.bg:hover{color:var(--t1);border-color:var(--b2);}
.bd{background:transparent;color:var(--danger);border-color:var(--danger);}
.bd:hover{background:var(--danger);color:#fff;}
.bsm{padding:4px 8px;font-size:10px;}
input[type=range]{-webkit-appearance:none;height:2px;background:var(--b2);border-radius:1px;outline:none;cursor:pointer;width:100%;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;background:var(--acc);border-radius:50%;cursor:pointer;}
.inp{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);color:var(--t1);font-family:var(--fm);font-size:12px;padding:6px 9px;outline:none;transition:border-color 100ms;width:100%;}
.inp::placeholder{color:var(--t3);}
.inp:focus{border-color:var(--acc);}
.inp.err{border-color:var(--danger);}
/* Palette */
#vpal{display:flex;flex:1;overflow:hidden;}
.pstrip{flex:1;display:flex;overflow:hidden;}
.slot{flex:1;display:flex;flex-direction:column;justify-content:flex-end;padding:16px 12px;position:relative;transition:flex 140ms var(--ease);min-width:38px;}
.slot:hover{flex:1.18;}
.sacts{position:absolute;top:10px;right:8px;display:flex;flex-direction:column;gap:4px;opacity:0;transition:opacity 120ms;}
.slot:hover .sacts{opacity:1;}
.sinfo{display:flex;flex-direction:column;gap:2px;}
.sname{font-family:var(--fd);font-size:10px;font-weight:600;opacity:.7;}
.shex{font-family:var(--fm);font-size:12px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;}
.shsl{font-size:10px;opacity:.55;}
.sbtn{width:26px;height:26px;border-radius:var(--r);border:none;background:rgba(0,0,0,.45);cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);font-size:12px;transition:background 100ms,transform 100ms;}
.sbtn:hover{background:rgba(0,0,0,.7);transform:scale(1.08);}
.sbtn.locked{background:rgba(232,255,0,.2);color:var(--acc);}
.toast{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.88);color:#fff;padding:4px 12px;border-radius:2px;font-size:11px;pointer-events:none;white-space:nowrap;animation:tin .12s ease forwards;}
@keyframes tin{from{opacity:0;transform:translate(-50%,-44%)}to{opacity:1;transform:translate(-50%,-50%)}}
.prevstrip{display:flex;height:22px;border-radius:2px;overflow:hidden;gap:2px;margin-top:8px;}
.hgrid{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.hbtn{padding:6px 8px;background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);color:var(--t3);font-family:var(--fm);font-size:11px;cursor:pointer;text-align:left;transition:border-color 100ms,color 100ms,background 100ms;}
.hbtn:hover{border-color:var(--b2);color:var(--t1);}
.hbtn.on{background:var(--acc);border-color:var(--acc);color:#000;font-weight:700;}
.hdesc{font-size:11px;color:var(--t3);margin-bottom:8px;line-height:1.6;min-height:2.4em;}
.seedlist{display:flex;flex-direction:column;gap:4px;margin-bottom:8px;}
.seeditem{display:flex;align-items:center;gap:6px;}
.seedsw{width:18px;height:18px;border-radius:2px;border:1px solid rgba(255,255,255,.08);flex-shrink:0;}
.seedhex{flex:1;font-size:10px;letter-spacing:.05em;text-transform:uppercase;color:var(--t2);}
.seedrm{background:none;border:none;color:var(--t3);cursor:pointer;font-size:14px;line-height:1;transition:color 100ms;}
.seedrm:hover{color:var(--danger);}
.seedrow{display:flex;gap:5px;}
.themes-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.theme-card{border-radius:3px;overflow:hidden;cursor:pointer;border:1px solid var(--b1);transition:border-color 120ms;}
.theme-card:hover{border-color:var(--b2);}
.theme-strip{height:32px;display:flex;}
.theme-chip{flex:1;}
.theme-label{padding:6px 8px;background:var(--s2);font-family:var(--fd);font-size:11px;font-weight:600;color:var(--t2);}
/* Picker */
#vpick{display:none;flex:1;overflow:hidden;}
.picker-main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:24px;overflow:auto;}
.wheel-wrap{position:relative;flex-shrink:0;}
#colorWheel{border-radius:50%;cursor:crosshair;touch-action:none;display:block;}
.wheel-cursor{position:absolute;width:14px;height:14px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.5),0 2px 6px rgba(0,0,0,.4);pointer-events:none;transform:translate(-50%,-50%);}
.sliders-section{width:100%;max-width:400px;display:flex;flex-direction:column;gap:14px;}
.slider-row{display:flex;flex-direction:column;gap:6px;}
.slider-label{display:flex;justify-content:space-between;font-size:11px;color:var(--t3);}
.slider-label span{color:var(--t1);font-weight:700;}
.hue-track{height:10px;border-radius:5px;background:linear-gradient(to right,#f00,#ff0,#0f0,#0ff,#00f,#f0f,#f00);margin:2px 0;}
.sat-track,.lit-track{height:10px;border-radius:5px;margin:2px 0;}
.hue-track input,.sat-track input,.lit-track input{-webkit-appearance:none;width:100%;height:100%;background:transparent;cursor:pointer;margin:0;display:block;}
.hue-track input::-webkit-slider-thumb,.sat-track input::-webkit-slider-thumb,.lit-track input::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.5);cursor:pointer;}
.hue-track input::-webkit-slider-runnable-track,.sat-track input::-webkit-slider-runnable-track,.lit-track input::-webkit-slider-runnable-track{height:10px;border-radius:5px;background:transparent;}
.color-preview-row{display:flex;align-items:center;gap:12px;width:100%;max-width:400px;}
.cprev{width:56px;height:56px;border-radius:4px;border:2px solid var(--b2);flex-shrink:0;}
.cprev-inputs{flex:1;display:flex;flex-direction:column;gap:6px;}
.hex-inp-row{display:flex;gap:6px;align-items:center;}
.hex-inp-row label{font-size:10px;color:var(--t3);min-width:28px;}
.picker-panel{width:var(--pw);background:var(--s1);border-left:1px solid var(--b1);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;padding:14px 16px;gap:14px;}
.recent-swatches{display:flex;flex-wrap:wrap;gap:5px;}
.rswatch{width:22px;height:22px;border-radius:3px;cursor:pointer;border:1px solid rgba(255,255,255,.06);transition:transform 100ms;}
.rswatch:hover{transform:scale(1.15);}
/* Scale */
#vscale{display:none;flex:1;overflow:hidden;}
.scale-main{flex:1;display:flex;flex-direction:column;overflow:auto;padding:24px;}
.scale-grid{display:flex;flex-direction:column;gap:6px;max-width:900px;}
.scale-row{display:flex;border-radius:3px;overflow:hidden;height:52px;}
.scale-chip{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:2px;font-family:var(--fm);font-size:10px;cursor:pointer;transition:flex 100ms;}
.scale-chip:hover{flex:1.4;}
.scale-step-label{font-weight:700;letter-spacing:.04em;}
.scale-hex-label{opacity:.65;font-size:9px;}
.scale-panel{width:var(--pw);background:var(--s1);border-left:1px solid var(--b1);overflow-y:auto;flex-shrink:0;padding:14px 16px;}
.token-pre{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:10px;font-size:10px;line-height:1.7;color:var(--t3);white-space:pre;overflow-x:auto;max-height:300px;overflow-y:auto;}
/* Sim */
#vsim{display:none;flex:1;overflow:auto;padding:24px;}
.sim-types{display:grid;grid-template-columns:1fr 1fr;gap:14px;max-width:960px;}
.sim-card{background:var(--s1);border:1px solid var(--b1);border-radius:3px;overflow:hidden;}
.sim-card-hd{padding:10px 14px;border-bottom:1px solid var(--b1);display:flex;justify-content:space-between;align-items:baseline;gap:8px;}
.sim-card-title{font-family:var(--fd);font-size:13px;font-weight:700;}
.sim-card-sub{font-size:10px;color:var(--t3);text-align:right;}
.sim-strip{height:60px;display:flex;}
.sim-chip{flex:1;display:flex;align-items:flex-end;padding:5px 3px;}
.sim-chip-hex{font-size:9px;font-family:var(--fm);writing-mode:vertical-rl;transform:rotate(180deg);opacity:.7;}
/* Gradient */
#vgrad{display:none;flex:1;overflow:hidden;}
.grad-main{flex:1;display:flex;flex-direction:column;overflow:auto;padding:24px;}
.grad-preview{width:100%;height:200px;border-radius:4px;margin-bottom:16px;border:1px solid var(--b1);overflow:hidden;max-width:960px;flex-shrink:0;}
.grad-stops{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;max-width:960px;align-items:center;}
.stop-chip{width:36px;height:36px;border-radius:3px;border:2px solid var(--b1);cursor:pointer;position:relative;transition:border-color 100ms;flex-shrink:0;}
.stop-chip.selected{border-color:var(--acc);}
.stop-rm{position:absolute;top:-6px;right:-6px;width:14px;height:14px;background:var(--danger);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;opacity:0;transition:opacity 100ms;cursor:pointer;border:none;color:#fff;padding:0;line-height:1;}
.stop-chip:hover .stop-rm{opacity:1;}
.add-stop{width:36px;height:36px;border-radius:3px;border:1px dashed var(--b2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--t3);background:transparent;transition:border-color 100ms,color 100ms;}
.add-stop:hover{border-color:var(--acc);color:var(--acc);}
.grad-css-box{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:12px;font-family:var(--fm);font-size:11px;line-height:1.8;color:var(--t3);white-space:pre-wrap;word-break:break-all;max-width:960px;}
.grad-panel{width:var(--pw);background:var(--s1);border-left:1px solid var(--b1);overflow-y:auto;flex-shrink:0;padding:14px 16px;display:flex;flex-direction:column;gap:14px;}
.type-btns,.dir-btns{display:flex;gap:4px;flex-wrap:wrap;}
/* Shared view header */
.view-hd{margin-bottom:20px;}
.view-hd h2{font-family:var(--fd);font-size:20px;font-weight:800;margin-bottom:4px;}
.view-hd p{font-size:12px;color:var(--t3);}
/* Converter */
.conv-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.conv-card{background:var(--s1);border:1px solid var(--b1);border-radius:3px;padding:14px;position:relative;}
.conv-label{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--t3);margin-bottom:6px;font-family:var(--fd);}
.conv-val{font-family:var(--fm);font-size:12px;word-break:break-all;margin-bottom:2px;}
.conv-sub{font-size:10px;color:var(--t3);}
.conv-copy{position:absolute;top:10px;right:10px;background:var(--s2);border:1px solid var(--b1);border-radius:2px;color:var(--t3);font-size:10px;padding:2px 7px;cursor:pointer;font-family:var(--fm);transition:color 100ms;}
.conv-copy:hover{color:var(--t1);}
/* A11y */
.a11y-badge{display:inline-block;padding:2px 6px;border-radius:2px;font-size:10px;font-weight:700;letter-spacing:.03em;}
/* Saved */
.saved-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:10px;}
.saved-card{background:var(--s1);border:1px solid var(--b1);border-radius:3px;overflow:hidden;transition:border-color 120ms;}
.saved-card:hover{border-color:var(--b2);}
/* Image */
.drop-zone{border:2px dashed var(--b2);border-radius:6px;padding:48px 24px;text-align:center;cursor:pointer;position:relative;transition:border-color 150ms,background 150ms;}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--acc);background:rgba(232,255,0,.03);}
/* Modals */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(6px);animation:fin .1s ease;}
@keyframes fin{from{opacity:0}to{opacity:1}}
.modal{background:var(--s1);border:1px solid var(--b2);border-radius:4px;width:480px;max-width:96vw;overflow:hidden;animation:sup .15s var(--ease);}
@keyframes sup{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
.mhd{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;border-bottom:1px solid var(--b1);}
.mhd h2{font-family:var(--fd);font-size:14px;font-weight:700;}
.mcl{background:none;border:none;color:var(--t3);font-size:20px;cursor:pointer;line-height:1;padding:0;}
.mcl:hover{color:var(--t1);}
.mbd{padding:16px;display:flex;flex-direction:column;gap:12px;}
.mft{display:flex;gap:6px;padding:12px 16px;border-top:1px solid var(--b1);justify-content:flex-end;}
.expre{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:12px;font-family:var(--fm);font-size:11px;line-height:1.8;color:var(--t3);white-space:pre;overflow-x:auto;max-height:180px;overflow-y:auto;}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}
@media(max-width:700px){
  .panel,.picker-panel,.scale-panel,.grad-panel{width:100%;border-left:none;border-top:1px solid var(--b1);}
  #vpal,#vpick,#vscale,#vgrad{flex-direction:column;}
  .pstrip{flex-direction:column;}
  .slot{min-height:70px;flex:none;}
  .sim-types,.conv-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="app">
<header class="hdr">
  <div class="brand">Chroma<sup>v3</sup></div>
  <nav class="nav">
    <button class="nb on"  data-view="pal">Palette</button>
    <button class="nb" data-view="pick">Color Picker</button>
    <button class="nb" data-view="scale">Tint/Shade</button>
    <button class="nb" data-view="sim">Color Blindness</button>
    <button class="nb" data-view="grad">Gradients</button>
    <button class="nb" data-view="conv">Converter</button>
    <button class="nb" data-view="a11y">Accessibility</button>
    <button class="nb" data-view="img">Image Extract</button>
    <button class="nb" data-view="saved">Saved</button>
  </nav>
  <div class="hbtns">
    <button class="btn bg bsm" id="btnUndo"   title="Undo (Ctrl+Z)">↩</button>
    <button class="btn bg bsm" id="btnShare"  title="Share URL">⤴</button>
    <button class="btn bg bsm" id="btnSave"   title="Save palette">♡</button>
    <button class="btn bg bsm" id="btnExport" title="Export">↗</button>
  </div>
</header>

<!-- PALETTE -->
<div id="vpal" style="display:flex;flex:1;overflow:hidden;">
  <div class="pstrip" id="pstrip"></div>
  <aside class="panel">
    <div class="pscroll">
      <div class="psec">
        <div class="slabel">Colors</div>
        <div style="display:flex;align-items:center;gap:10px;">
          <div id="countNum" style="font-family:var(--fd);font-size:22px;font-weight:800;color:var(--acc);min-width:26px;text-align:center;">6</div>
          <input type="range" id="countRange" min="4" max="12" value="6"/>
          <span style="font-size:10px;color:var(--t3)">12</span>
        </div>
      </div>
      <div class="psec">
        <div class="slabel">Themes</div>
        <div class="themes-grid" id="themesGrid"></div>
      </div>
      <div class="psec">
        <div class="slabel">Seed Colors</div>
        <div class="seedlist" id="seedList"></div>
        <div class="seedrow">
          <input class="inp" id="seedInp" type="text" placeholder="#F4A261" maxlength="7" style="font-size:11px;" autocomplete="off" spellcheck="false"/>
          <button class="btn bg bsm" id="btnAddSeed">+ Add</button>
        </div>
      </div>
      <div class="psec">
        <div class="slabel">Harmony</div>
        <div class="hdesc" id="hdesc"></div>
        <div class="hgrid" id="hgrid"></div>
      </div>
      <div class="psec" id="prevSec" style="display:none">
        <div class="slabel">Preview</div>
        <div class="prevstrip" id="prevStrip"></div>
      </div>
    </div>
    <div class="genbar">
      <div class="genrow"><button class="btn bp" id="btnGen">⟳ Generate</button></div>
      <div class="hint">Press <kbd>Space</kbd> to generate · <kbd>Ctrl+Z</kbd> to undo</div>
    </div>
  </aside>
</div>

<!-- COLOR PICKER -->
<div id="vpick" style="display:none;flex:1;overflow:hidden;">
  <div class="picker-main">
    <div class="wheel-wrap">
      <canvas id="colorWheel" width="260" height="260"></canvas>
      <div class="wheel-cursor" id="wheelCursor"></div>
    </div>
    <div class="sliders-section">
      <div class="slider-row">
        <div class="slider-label">Hue <span id="hueVal">210</span>°</div>
        <div class="hue-track"><input type="range" id="hueSlider" min="0" max="359" step="1" value="210"/></div>
      </div>
      <div class="slider-row">
        <div class="slider-label">Saturation <span id="satVal">80</span>%</div>
        <div class="sat-track" id="satTrack"><input type="range" id="satSlider" min="0" max="100" value="80"/></div>
      </div>
      <div class="slider-row">
        <div class="slider-label">Lightness <span id="litVal">55</span>%</div>
        <div class="lit-track" id="litTrack"><input type="range" id="litSlider" min="0" max="100" value="55"/></div>
      </div>
    </div>
    <div class="color-preview-row">
      <div class="cprev" id="pickerPreview"></div>
      <div class="cprev-inputs">
        <div class="hex-inp-row">
          <label for="pickerHexInp">HEX</label>
          <input class="inp" id="pickerHexInp" type="text" maxlength="7" placeholder="#FF0000" style="letter-spacing:.06em;" autocomplete="off" spellcheck="false"/>
        </div>
        <div style="display:flex;gap:6px;margin-top:4px;">
          <button class="btn bp bsm" id="btnPickerUseSeed">→ Use as Seed</button>
          <button class="btn bg bsm" id="btnPickerAdd">+ Add to Palette</button>
        </div>
      </div>
    </div>
  </div>
  <div class="picker-panel">
    <div><div class="slabel">Recent Colors</div><div class="recent-swatches" id="recentSwatches"></div></div>
    <div><div class="slabel">Color Info</div><div id="pickerInfo" style="font-size:11px;color:var(--t3);line-height:2.1;"></div></div>
  </div>
</div>

<!-- TINT/SHADE SCALE -->
<div id="vscale" style="display:none;flex:1;overflow:hidden;">
  <div class="scale-main">
    <div class="view-hd"><h2>Tint / Shade Scale</h2><p>50–950 design token scale from any base color. Click a chip to copy.</p></div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:24px;">
      <div id="scaleSwatch" style="width:44px;height:44px;border-radius:3px;border:2px solid var(--b2);flex-shrink:0;"></div>
      <input class="inp" id="scaleInp" type="text" placeholder="#3B82F6" maxlength="7" style="flex:1;" autocomplete="off" spellcheck="false"/>
      <button class="btn bp bsm" id="btnGenScale">Generate</button>
    </div>
    <div class="scale-grid" id="scaleGrid"></div>
  </div>
  <div class="scale-panel">
    <div class="slabel">Token Name</div>
    <input class="inp" id="scaleNameInp" type="text" placeholder="primary" maxlength="24" style="margin-bottom:12px;" autocomplete="off"/>
    <div class="slabel">Export Format</div>
    <div style="display:flex;gap:4px;margin-bottom:10px;" id="tokenTabRow">
      <button class="btn bp bsm" data-ttab="css">CSS</button>
      <button class="btn bg bsm" data-ttab="js">JS</button>
      <button class="btn bg bsm" data-ttab="tailwind">Tailwind</button>
      <button class="btn bg bsm" data-ttab="json">JSON</button>
    </div>
    <pre class="token-pre" id="tokenPre"></pre>
    <button class="btn bg bsm" id="btnCopyTokens" style="width:100%;margin-top:8px;">Copy</button>
    <div class="slabel" style="margin-top:16px;">Use in Palette</div>
    <button class="btn bg bsm" id="btnScaleToSeeds" style="width:100%;">Use scale as seeds →</button>
  </div>
</div>

<!-- COLOR BLINDNESS -->
<div id="vsim" style="display:none;flex:1;overflow:auto;padding:24px;">
  <div class="view-hd"><h2>Color Blindness Simulator</h2><p>How your palette appears under different types of color vision deficiency.</p></div>
  <div class="sim-types" id="simTypes"></div>
</div>

<!-- GRADIENT -->
<div id="vgrad" style="display:none;flex:1;overflow:hidden;">
  <div class="grad-main">
    <div class="view-hd"><h2>Gradient Generator</h2><p>Build CSS gradients from your palette or custom color stops.</p></div>
    <div class="grad-preview" id="gradPreview"></div>
    <div class="grad-stops" id="gradStops"></div>
    <div style="font-size:11px;color:var(--t3);margin-bottom:8px;">CSS Output</div>
    <div class="grad-css-box" id="gradCssBox"></div>
    <div style="margin-top:8px;display:flex;gap:6px;">
      <button class="btn bg bsm" id="btnCopyGrad">Copy CSS</button>
      <button class="btn bg bsm" id="btnLoadPaletteToGrad">← Load from Palette</button>
    </div>
  </div>
  <div class="grad-panel">
    <div><div class="slabel">Type</div>
      <div class="type-btns" id="gtypeBtns">
        <button class="btn bp bsm" data-gtype="linear">Linear</button>
        <button class="btn bg bsm" data-gtype="radial">Radial</button>
        <button class="btn bg bsm" data-gtype="conic">Conic</button>
      </div>
    </div>
    <div id="dirSection"><div class="slabel">Direction</div>
      <div class="dir-btns" id="dirBtns">
        <button class="btn bp bsm" data-dir="to right">→</button>
        <button class="btn bg bsm" data-dir="to left">←</button>
        <button class="btn bg bsm" data-dir="to bottom">↓</button>
        <button class="btn bg bsm" data-dir="to top">↑</button>
        <button class="btn bg bsm" data-dir="to bottom right">↘</button>
        <button class="btn bg bsm" data-dir="to bottom left">↙</button>
        <button class="btn bg bsm" data-dir="135deg">135°</button>
        <button class="btn bg bsm" data-dir="45deg">45°</button>
      </div>
    </div>
    <div><div class="slabel">Selected Stop</div>
      <input class="inp" id="stopColorInp" type="text" placeholder="#FF0000" maxlength="7" autocomplete="off" spellcheck="false"/>
      <div style="margin-top:8px;">
        <input type="range" id="stopPosSlider" min="0" max="100" value="0"/>
        <div style="font-size:10px;color:var(--t3);margin-top:4px;">Position: <span id="stopPosVal">0</span>%</div>
      </div>
    </div>
    <div><div class="slabel">Presets</div><div style="display:flex;flex-direction:column;gap:4px;" id="gradPresets"></div></div>
  </div>
</div>

<!-- CONVERTER -->
<div id="vconv" style="display:none;flex:1;overflow:auto;padding:28px;">
  <div style="max-width:660px;margin:0 auto;">
    <div class="view-hd"><h2>Color Format Converter</h2><p>Paste any hex, rgb(), or hsl() value to see all formats instantly.</p></div>
    <div style="display:flex;gap:10px;margin-bottom:24px;align-items:center;">
      <div id="convSwatch" style="width:56px;height:56px;border-radius:4px;border:2px solid var(--b2);flex-shrink:0;transition:background .15s;"></div>
      <input class="inp" id="convInp" type="text" placeholder="#F4A261  ·  rgb(244,162,97)  ·  hsl(27,89%,67%)" style="font-size:13px;padding:11px 12px;" autocomplete="off" spellcheck="false"/>
    </div>
    <div class="conv-grid" id="convGrid"></div>
  </div>
</div>

<!-- ACCESSIBILITY -->
<div id="va11y" style="display:none;flex:1;overflow:auto;padding:24px;">
  <div style="max-width:920px;margin:0 auto;">
    <div class="view-hd"><h2>Accessibility Matrix</h2><p>WCAG 2.1 contrast ratios for every color pair in your palette.</p></div>
    <div id="a11yMatrix"></div>
    <div style="margin-top:24px;">
      <div class="slabel" style="margin-bottom:12px;">Top Passing Pairs</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;" id="a11yPairs"></div>
    </div>
  </div>
</div>

<!-- IMAGE EXTRACT -->
<div id="vimg" style="display:none;flex:1;overflow:auto;padding:24px;">
  <div style="max-width:780px;margin:0 auto;">
    <div class="view-hd"><h2>Image Color Extraction</h2><p>Upload an image to extract dominant colors and seed your palette.</p></div>
    <div class="drop-zone" id="dropZone">
      <input type="file" id="imgFile" accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer;"/>
      <div style="font-family:var(--fd);font-size:17px;font-weight:700;color:var(--t2);margin-bottom:6px;">Drop an image here</div>
      <div style="font-size:11px;color:var(--t3);">or click to browse · JPG, PNG, WebP, GIF</div>
    </div>
    <div id="imgPreviewRow" style="display:none;margin-top:20px;gap:18px;">
      <div style="flex:1;max-width:380px;"><img id="imgPreview" alt="Uploaded image preview" style="width:100%;border-radius:4px;border:1px solid var(--b2);display:block;"/></div>
      <div style="flex:1;">
        <div class="slabel" style="margin-bottom:10px;">Extracted Colors</div>
        <div id="imgColorsGrid" style="display:flex;flex-direction:column;gap:7px;"></div>
        <button class="btn bp bsm" id="btnUseExtracted" style="margin-top:14px;">Use as Seed Colors →</button>
      </div>
    </div>
  </div>
</div>

<!-- SAVED -->
<div id="vsaved" style="display:none;flex:1;overflow:auto;padding:24px;">
  <div style="max-width:920px;margin:0 auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2 style="font-family:var(--fd);font-size:20px;font-weight:800;">Saved Palettes</h2>
      <button class="btn bd bsm" id="btnClearAll" style="display:none;">Clear All</button>
    </div>
    <div id="savedContent"></div>
  </div>
</div>

<!-- MODALS -->
<div class="overlay" id="modalExport" style="display:none;" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mhd"><h2>Export</h2><button class="mcl" data-close="modalExport">×</button></div>
    <div class="mbd">
      <div style="display:flex;gap:4px;" id="expTabs">
        <button class="btn bp bsm" data-tab="hex">HEX</button>
        <button class="btn bg bsm" data-tab="css">CSS</button>
        <button class="btn bg bsm" data-tab="array">JS</button>
        <button class="btn bg bsm" data-tab="scss">SCSS</button>
      </div>
      <pre class="expre" id="expContent"></pre>
      <div id="expSwatch" style="display:flex;height:24px;border-radius:2px;overflow:hidden;gap:2px;"></div>
    </div>
    <div class="mft"><button class="btn bg" data-close="modalExport">Close</button><button class="btn bp" id="btnCopyExp">Copy</button></div>
  </div>
</div>
<div class="overlay" id="modalShare" style="display:none;" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mhd"><h2>Share Palette</h2><button class="mcl" data-close="modalShare">×</button></div>
    <div class="mbd">
      <p style="font-size:12px;color:var(--t3);">Anyone with this URL can load your exact palette.</p>
      <textarea id="shareUrl" rows="2" readonly style="width:100%;background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);color:var(--t2);font-family:var(--fm);font-size:11px;padding:9px;resize:none;outline:none;line-height:1.6;"></textarea>
      <div id="shareSwatch" style="display:flex;height:24px;border-radius:2px;overflow:hidden;gap:2px;"></div>
    </div>
    <div class="mft"><button class="btn bg" data-close="modalShare">Close</button><button class="btn bp" id="btnCopyUrl">Copy URL</button></div>
  </div>
</div>
<div class="overlay" id="modalSave" style="display:none;" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mhd"><h2>Save Palette</h2><button class="mcl" data-close="modalSave">×</button></div>
    <div class="mbd">
      <div id="saveSwatch" style="display:flex;height:36px;border-radius:3px;overflow:hidden;gap:2px;"></div>
      <input class="inp" id="saveNameInp" type="text" placeholder="Name your palette…" maxlength="40" autocomplete="off"/>
    </div>
    <div class="mft"><button class="btn bg" data-close="modalSave">Cancel</button><button class="btn bp" id="btnConfirmSave">Save</button></div>
  </div>
</div>

<script>
'use strict';

// ═══════════════════════════════════════════════════════════
// COLOR MATH — single source of truth
// ═══════════════════════════════════════════════════════════
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

function toLinear(v) { return v <= 0.04045 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4); }
function fromLinear(v) { return v <= 0.0031308 ? 12.92 * v : 1.055 * Math.pow(v, 1 / 2.4) - 0.055; }

function hexToRgb(hex) {
  const c = hex.replace('#', '');
  const f = c.length === 3 ? c.split('').map(x => x + x).join('') : c;
  const n = parseInt(f, 16);
  return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
}
function rgbToHex({ r, g, b }) {
  return '#' + [r, g, b].map(v => v.toString(16).padStart(2, '0')).join('');
}
function rgbToHsl({ r, g, b }) {
  const rn = r/255, gn = g/255, bn = b/255;
  const mx = Math.max(rn,gn,bn), mn = Math.min(rn,gn,bn), l = (mx+mn)/2;
  if (mx === mn) return { h:0, s:0, l:l*100 };
  const d = mx - mn, s = l > 0.5 ? d/(2-mx-mn) : d/(mx+mn);
  let h = 0;
  if (mx === rn) h = ((gn-bn)/d + (gn<bn?6:0))/6;
  else if (mx === gn) h = ((bn-rn)/d + 2)/6;
  else h = ((rn-gn)/d + 4)/6;
  return { h:h*360, s:s*100, l:l*100 };
}
function hslToRgb({ h, s, l }) {
  const sn = s/100, ln = l/100;
  if (sn === 0) { const v = Math.round(ln*255); return { r:v, g:v, b:v }; }
  const q = ln < 0.5 ? ln*(1+sn) : ln+sn-ln*sn, p = 2*ln-q, hk = h/360;
  const ch = t => { const x=((t%1)+1)%1; return x<1/6?p+(q-p)*6*x:x<0.5?q:x<2/3?p+(q-p)*(2/3-x)*6:p; };
  return { r:Math.round(ch(hk+1/3)*255), g:Math.round(ch(hk)*255), b:Math.round(ch(hk-1/3)*255) };
}
function rgbToHsv({ r, g, b }) {
  const rn=r/255, gn=g/255, bn=b/255, mx=Math.max(rn,gn,bn), mn=Math.min(rn,gn,bn), d=mx-mn;
  let h=0;
  if (d>0) { if(mx===rn) h=((gn-bn)/d+(gn<bn?6:0))/6; else if(mx===gn) h=((bn-rn)/d+2)/6; else h=((rn-gn)/d+4)/6; }
  return { h:h*360, s:mx===0?0:(d/mx)*100, v:mx*100 };
}
function rgbToCmyk({ r, g, b }) {
  const rn=r/255, gn=g/255, bn=b/255, k=1-Math.max(rn,gn,bn);
  if (k===1) return { c:0,m:0,y:0,k:100 };
  const d=1-k;
  return { c:Math.round((1-rn-k)/d*100), m:Math.round((1-gn-k)/d*100), y:Math.round((1-bn-k)/d*100), k:Math.round(k*100) };
}
function rgbToOklab({ r, g, b }) {
  const rl=toLinear(r/255), gl=toLinear(g/255), bl=toLinear(b/255);
  const l=Math.cbrt(0.4122214708*rl+0.5363325363*gl+0.0514459929*bl);
  const m=Math.cbrt(0.2119034982*rl+0.6806995451*gl+0.1073969566*bl);
  const s=Math.cbrt(0.0883024619*rl+0.2817188376*gl+0.6299787005*bl);
  return { L:0.2104542553*l+0.7936177850*m-0.0040720468*s, a:1.9779984951*l-2.4285922050*m+0.4505937099*s, b:0.0259040371*l+0.7827717662*m-0.8086757660*s };
}
function oklabToLch({ L, a, b }) {
  return { L:L*100, C:Math.sqrt(a*a+b*b)*100, H:((Math.atan2(b,a)*180/Math.PI)+360)%360 };
}
function luminance({ r, g, b }) {
  return 0.2126*toLinear(r/255) + 0.7152*toLinear(g/255) + 0.0722*toLinear(b/255);
}
function contrastRatio(a, b) {
  const la=luminance(a), lb=luminance(b);
  return (Math.max(la,lb)+0.05)/(Math.min(la,lb)+0.05);
}
function wcagLevel(r) { return r>=7?'AAA':r>=4.5?'AA':r>=3?'AA Large':'Fail'; }
function textColor(bg) { return contrastRatio(bg,{r:255,g:255,b:255})>=4.5?'#ffffff':'#000000'; }
function colorDist(a, b) {
  const la=rgbToOklab(a), lb=rgbToOklab(b);
  return Math.sqrt((la.L-lb.L)**2+(la.a-lb.a)**2+(la.b-lb.b)**2);
}
function parseHex(s) {
  const c=s.trim().replace(/^#/,'');
  if (/^[0-9a-fA-F]{3}$/.test(c)) return '#'+c.split('').map(x=>x+x).join('');
  if (/^[0-9a-fA-F]{6}$/.test(c)) return '#'+c;
  return null;
}
function parseRgbStr(s) {
  const m=s.match(/rgba?\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)/);
  return m?{r:clamp(Math.round(+m[1]),0,255),g:clamp(Math.round(+m[2]),0,255),b:clamp(Math.round(+m[3]),0,255)}:null;
}
function parseHslStr(s) {
  const m=s.match(/hsla?\(\s*([\d.]+)[,\s]\s*([\d.]+)%?[,\s]\s*([\d.]+)%?/);
  return m?hslToRgb({h:+m[1]%360,s:clamp(+m[2],0,100),l:clamp(+m[3],0,100)}):null;
}
function parseAny(s) { const h=parseHex(s); return h?hexToRgb(h):parseRgbStr(s)||parseHslStr(s); }

// ═══════════════════════════════════════════════════════════
// COLOR NAMES — pre-parsed at startup, OKLab nearest-neighbor
// ═══════════════════════════════════════════════════════════
const NAMED = [
  ['Crimson','#DC143C'],['Firebrick','#B22222'],['Scarlet','#FF2400'],['Tomato','#FF6347'],
  ['Coral','#FF7F50'],['Indian Red','#CD5C5C'],['Carmine','#960018'],['Ruby','#9B111E'],
  ['Raspberry','#872657'],['Rose','#FF007F'],['Hot Pink','#FF69B4'],['Deep Pink','#FF1493'],
  ['Flamingo','#FC8EAC'],['Blush','#DE5D83'],['Cerise','#DE3163'],['Amaranth','#E52B50'],
  ['Orange','#FF8C00'],['Tangerine','#F28500'],['Amber','#FFBF00'],['Pumpkin','#FF7518'],
  ['Burnt Orange','#CC5500'],['Terracotta','#C26A49'],['Sienna','#A0522D'],['Peru','#CD853F'],
  ['Copper','#B87333'],['Ochre','#CC7722'],['Saffron','#F4C430'],['Apricot','#FBCEB1'],
  ['Peach','#FFCBA4'],['Salmon','#FA8072'],['Yellow','#FFE600'],['Gold','#FFD700'],
  ['Goldenrod','#DAA520'],['Lemon','#FFF44F'],['Corn','#FBEC5D'],['Khaki','#C3B091'],
  ['Sand','#C2B280'],['Cream','#FFFDD0'],['Ivory','#FFFFF0'],['Beige','#F5F5DC'],
  ['Wheat','#F5DEB3'],['Green','#008000'],['Lime','#00FF00'],['Forest Green','#228B22'],
  ['Emerald','#50C878'],['Jade','#00A86B'],['Mint','#98FF98'],['Sage','#8FAE8B'],
  ['Fern','#4F7942'],['Moss','#8A9A5B'],['Olive','#808000'],['Avocado','#568203'],
  ['Chartreuse','#7FFF00'],['Spring Green','#00FF7F'],['Sea Green','#2E8B57'],
  ['Aquamarine','#7FFFD4'],['Tea Green','#D0F0C0'],['Hunter Green','#355E3B'],
  ['Pine','#01796F'],['Viridian','#40826D'],['Teal','#008080'],['Cyan','#00FFFF'],
  ['Turquoise','#40E0D0'],['Dark Turquoise','#00CED1'],['Cadet Blue','#5F9EA0'],
  ['Cerulean','#007BA7'],['Sky Blue','#87CEEB'],['Verdigris','#43B3AE'],
  ['Blue','#0000FF'],['Navy','#001F5B'],['Royal Blue','#4169E1'],['Cobalt','#0047AB'],
  ['Sapphire','#0F52BA'],['Cornflower Blue','#6495ED'],['Dodger Blue','#1E90FF'],
  ['Steel Blue','#4682B4'],['Slate Blue','#6A5ACD'],['Denim','#1560BD'],['Iris','#5A4FCF'],
  ['Periwinkle','#CCCCFF'],['Azure','#007FFF'],['Baby Blue','#89CFF0'],
  ['Midnight Blue','#191970'],['Purple','#800080'],['Violet','#EE82EE'],
  ['Indigo','#4B0082'],['Lavender','#E6E6FA'],['Mauve','#E0B0FF'],['Plum','#DDA0DD'],
  ['Orchid','#DA70D6'],['Fuchsia','#FF00FF'],['Wisteria','#C9A0DC'],['Lilac','#C8A2C8'],
  ['Heliotrope','#DF73FF'],['Thistle','#D8BFD8'],['Medium Purple','#9370DB'],
  ['Rebecca Purple','#663399'],['Amethyst','#9966CC'],['Grape','#6F2DA8'],
  ['Eggplant','#614051'],['Pink','#FFC0CB'],['Carnation','#FFA6C9'],
  ['Bubblegum','#FE5BAC'],['Watermelon','#FC6C85'],['Brown','#8B4513'],
  ['Chocolate','#D2691E'],['Caramel','#C68642'],['Tan','#D2B48C'],['Mocha','#8B5A2B'],
  ['Coffee','#6F4E37'],['Espresso','#4C2C2A'],['Sepia','#704214'],['Walnut','#5C3317'],
  ['Chestnut','#954535'],['Mahogany','#C04000'],['Rust','#B7410E'],
  ['Burnt Sienna','#E97451'],['White','#FFFFFF'],['Snow','#FFFAFA'],
  ['Seashell','#FFF5EE'],['Antique White','#FAEBD7'],['Light Gray','#D3D3D3'],
  ['Silver','#C0C0C0'],['Gray','#808080'],['Slate Gray','#708090'],
  ['Dim Gray','#696969'],['Charcoal','#36454F'],['Ash','#B2BEB5'],
  ['Graphite','#474A51'],['Jet','#343434'],['Black','#000000'],
  ['Rose Gold','#B76E79'],['Champagne','#FAD6A5'],['Bronze','#CD7F32'],
  ['Brass','#B5A642'],['Gunmetal','#2A3439'],['Celadon','#ACE1AF'],['Vermilion','#E34234'],
].map(([name, hex]) => ({ name, hex: hex.toLowerCase(), rgb: hexToRgb(hex) }));

function nearestName(rgb) {
  let best = NAMED[0], bestD = colorDist(rgb, best.rgb);
  for (let i = 1; i < NAMED.length; i++) {
    const d = colorDist(rgb, NAMED[i].rgb);
    if (d < bestD) { bestD = d; best = NAMED[i]; }
  }
  return best.name;
}

// ═══════════════════════════════════════════════════════════
// HARMONIES
// ═══════════════════════════════════════════════════════════
const HARMONIES = [
  {id:'analogous',     label:'Analogous',     desc:'Adjacent hues — harmonious and serene.'},
  {id:'complementary', label:'Complementary', desc:'Colors opposite on the wheel — high contrast.'},
  {id:'split-comp',    label:'Split-Comp',    desc:'A base plus two adjacent to its complement.'},
  {id:'triadic',       label:'Triadic',       desc:'Three evenly-spaced hues — vibrant and diverse.'},
  {id:'tetradic',      label:'Tetradic',      desc:'Four hues in two complementary pairs.'},
  {id:'square',        label:'Square',        desc:'Four hues equally spaced at 90°.'},
  {id:'monochromatic', label:'Monochromatic', desc:'One hue, varying saturation and lightness.'},
  {id:'shades',        label:'Shades & Tints',desc:'Deep shadow to bright highlight on one hue.'},
  {id:'double-split',  label:'Double Split',  desc:'Two split-complementary pairs — complex.'},
  {id:'compound',      label:'Compound',      desc:'Near-complementary — sophisticated, nuanced.'},
  {id:'natural',       label:'Natural',       desc:'Muted, organic, naturalistic tones.'},
  {id:'random',        label:'Random',        desc:'Golden-ratio hue stepping — always harmonious.'},
];

function rotateHue(h, d) { return ((h + d) % 360 + 360) % 360; }
function makeStop(hsl) { const rgb = hslToRgb(hsl); return { hex: rgbToHex(rgb), rgb, hsl }; }

function anchorHues(mode, h) {
  switch (mode) {
    case 'complementary': return [h, rotateHue(h,180)];
    case 'split-comp':    return [h, rotateHue(h,150), rotateHue(h,210)];
    case 'triadic':       return [h, rotateHue(h,120), rotateHue(h,240)];
    case 'tetradic': case 'square': return [h, rotateHue(h,90), rotateHue(h,180), rotateHue(h,270)];
    case 'analogous':     return [-2,-1,0,1,2].map(i=>rotateHue(h,i*30));
    case 'double-split':  return [rotateHue(h,-30),h,rotateHue(h,30),rotateHue(h,150),rotateHue(h,210)];
    case 'compound':      return [h,rotateHue(h,150),rotateHue(h,180),rotateHue(h,210)];
    default: return [h];
  }
}

function genPalette(mode, count, seeds) {
  const base = (seeds && seeds.length > 0) ? seeds[0] : {h:Math.random()*360, s:40+Math.random()*50, l:35+Math.random()*35};
  if (mode === 'monochromatic') return Array.from({length:count},(_,i)=>{
    const t=count===1?.5:i/(count-1); return makeStop({h:base.h,s:clamp(base.s+(Math.random()-.5)*12,10,95),l:15+t*70});
  });
  if (mode === 'shades') return Array.from({length:count},(_,i)=>{
    const t=count===1?.5:i/(count-1); return makeStop({h:base.h,s:clamp(base.s-t*20,10,95),l:8+t*82});
  });
  if (mode === 'natural') return Array.from({length:count},()=>makeStop({h:rotateHue(base.h+(Math.random()-.5)*50,0),s:15+Math.random()*45,l:25+Math.random()*50}));
  if (mode === 'random') { const bh=Math.random()*360; return Array.from({length:count},(_,i)=>makeStop({h:rotateHue(bh+i*137.508,0),s:45+Math.random()*45,l:35+Math.random()*35})); }
  if (seeds && seeds.length > 1) {
    const stops = seeds.map(s=>makeStop(s));
    const need = count - stops.length;
    const hues = anchorHues(mode, seeds[0].h);
    for (let i=0; i<need; i++) stops.push(makeStop({h:hues[i%hues.length],s:clamp(seeds[0].s+(Math.random()-.5)*15,25,95),l:clamp(seeds[0].l+(Math.random()-.5)*30,20,80)}));
    return stops.slice(0, count);
  }
  const hues = anchorHues(mode, base.h);
  const total = Math.ceil(count/hues.length);
  return Array.from({length:count},(_,i)=>{
    const cycle=Math.floor(i/hues.length);
    const lv=total>1?(cycle/(total-1))*40-20:(Math.random()-.5)*22;
    return makeStop({h:hues[i%hues.length],s:clamp(base.s+(Math.random()-.5)*15,25,95),l:clamp(base.l+lv,20,80)});
  });
}

// ═══════════════════════════════════════════════════════════
// THEMES
// ═══════════════════════════════════════════════════════════
const THEMES = [
  {name:'Forest',         mode:'analogous',     seeds:['#2D5016','#5C8A3C','#8FBC5A','#C8E6A0','#3D7A4A']},
  {name:'Sunset',         mode:'analogous',     seeds:['#FF6B35','#F7C59F','#FF4D6D','#C9184A','#FFBA08']},
  {name:'Ocean Wave',     mode:'analogous',     seeds:['#0077B6','#00B4D8','#90E0EF','#CAF0F8','#48CAE4']},
  {name:'Blue Lagoon',    mode:'complementary', seeds:['#006994','#0099CC','#66CCDD','#FFDD99','#FF9944']},
  {name:'Mystic Night',   mode:'analogous',     seeds:['#10002B','#240046','#3C096C','#7B2FBE','#E0AAFF']},
  {name:'Rose Garden',    mode:'analogous',     seeds:['#FF006E','#FB5607','#FFBE0B','#FF4D6D','#C9184A']},
  {name:'Desert Sand',    mode:'analogous',     seeds:['#C67B3B','#DDA15E','#BC6C25','#FEFAE0','#606C38']},
  {name:'Aurora',         mode:'analogous',     seeds:['#6A0572','#AB83A1','#00F5D4','#00BBF9','#F15BB5']},
  {name:'Harvest',        mode:'analogous',     seeds:['#D62828','#F77F00','#FCBF49','#EAE2B7','#003049']},
  {name:'Crashing Wave',  mode:'split-comp',    seeds:['#023E8A','#0077B6','#48CAE4','#ADE8F4','#90E0EF']},
  {name:'Wildflower',     mode:'triadic',       seeds:['#E040FB','#00E676','#FFEB3B','#FF4081','#40C4FF']},
  {name:'Stormy',         mode:'monochromatic', seeds:['#37474F']},
  {name:'Cherry Blossom', mode:'analogous',     seeds:['#FF85A1','#FFB3C6','#FF4D6D','#FFC2D4','#FFCCD5']},
  {name:'Cyber',          mode:'complementary', seeds:['#00F5D4','#F72585','#7209B7','#3A0CA3','#4CC9F0']},
  {name:'Earth',          mode:'analogous',     seeds:['#8B4513','#A0522D','#6B4226','#DEB887','#C8A47E']},
  {name:'Lagoon',         mode:'analogous',     seeds:['#006D5B','#40826D','#ACE1AF','#20B2AA','#48D1CC']},
];

// ═══════════════════════════════════════════════════════════
// COLOR BLINDNESS SIMULATION
// Matrices: Brettel, Viénot & Mollon 1997 + Machado 2009
// ═══════════════════════════════════════════════════════════
const CB_TYPES = [
  {id:'normal',        name:'Normal Vision',  desc:'Full color perception',                   matrix:[1,0,0,0,1,0,0,0,1]},
  {id:'deuteranopia',  name:'Deuteranopia',   desc:'Green-blind · ~6% of males',              matrix:[0.367,0.861,-0.228,0.280,0.673,0.047,-0.012,0.043,0.969]},
  {id:'protanopia',    name:'Protanopia',     desc:'Red-blind · ~2% of males',               matrix:[0.152,1.053,-0.205,0.115,0.786,0.099,-0.004,-0.048,1.052]},
  {id:'tritanopia',    name:'Tritanopia',     desc:'Blue-yellow blind · ~0.01%',              matrix:[1.256,-0.077,-0.179,-0.079,0.931,0.148,0.005,0.691,0.304]},
  {id:'achromatopsia', name:'Achromatopsia',  desc:'Complete color blindness · very rare',    matrix:[0.299,0.587,0.114,0.299,0.587,0.114,0.299,0.587,0.114]},
  {id:'deuteranomaly', name:'Deuteranomaly',  desc:'Reduced green sensitivity · ~5% of males',matrix:[0.531,0.566,-0.097,0.176,0.764,0.060,-0.004,0.040,0.964]},
];
function applySimMatrix(rgb, M) {
  const R=toLinear(rgb.r/255), G=toLinear(rgb.g/255), B=toLinear(rgb.b/255);
  return {
    r:Math.round(fromLinear(clamp(M[0]*R+M[1]*G+M[2]*B,0,1))*255),
    g:Math.round(fromLinear(clamp(M[3]*R+M[4]*G+M[5]*B,0,1))*255),
    b:Math.round(fromLinear(clamp(M[6]*R+M[7]*G+M[8]*B,0,1))*255)
  };
}
function simulateColor(rgb, cbType) { return cbType.id==='normal'?rgb:applySimMatrix(rgb,cbType.matrix); }

// ═══════════════════════════════════════════════════════════
// TINT / SHADE SCALE
// ═══════════════════════════════════════════════════════════
const SCALE_STEPS = [50,100,200,300,400,500,600,700,800,900,950];
function generateScale(hex) {
  const hsl = rgbToHsl(hexToRgb(hex));
  return SCALE_STEPS.map(step => {
    const t = step/1000;
    const l = clamp(95-t*88, 5, 95);
    const s = clamp(hsl.s*(1-Math.abs(t-0.45)*0.5), 0, 100);
    const rgb = hslToRgb({h:hsl.h, s, l});
    return { step, hex:rgbToHex(rgb), rgb, hsl:{h:hsl.h,s,l} };
  });
}
let currentScale = [];
let currentScaleName = 'primary';

// ═══════════════════════════════════════════════════════════
// GRADIENT GENERATOR
// ═══════════════════════════════════════════════════════════
let gradState = {
  type:'linear', dir:'to right',
  stops:[{hex:'#6366f1',pos:0},{hex:'#ec4899',pos:100}],
  selectedStop:0
};
const GRAD_PRESETS = [
  {name:'Ocean Breeze', type:'linear', dir:'to right',        stops:[{hex:'#0077b6',pos:0},{hex:'#00b4d8',pos:50},{hex:'#90e0ef',pos:100}]},
  {name:'Sunset Glow',  type:'linear', dir:'to bottom right', stops:[{hex:'#ff4d6d',pos:0},{hex:'#ff9f1c',pos:50},{hex:'#ffbf69',pos:100}]},
  {name:'Midnight',     type:'linear', dir:'to bottom',       stops:[{hex:'#10002b',pos:0},{hex:'#3c096c',pos:50},{hex:'#7b2fbe',pos:100}]},
  {name:'Aurora',       type:'linear', dir:'to right',        stops:[{hex:'#00f5d4',pos:0},{hex:'#00bbf9',pos:50},{hex:'#f15bb5',pos:100}]},
  {name:'Forest',       type:'linear', dir:'135deg',          stops:[{hex:'#2d5016',pos:0},{hex:'#5c8a3c',pos:50},{hex:'#c8e6a0',pos:100}]},
  {name:'Rose Gold',    type:'radial', dir:'',                stops:[{hex:'#b76e79',pos:0},{hex:'#fad6a5',pos:100}]},
  {name:'Cyber',        type:'conic',  dir:'from 0deg',       stops:[{hex:'#7209b7',pos:0},{hex:'#f72585',pos:50},{hex:'#00f5d4',pos:100}]},
];
function buildGradientCss() {
  const sorted = gradState.stops.slice().sort((a,b)=>a.pos-b.pos);
  const str = sorted.map(x=>`${x.hex} ${x.pos}%`).join(', ');
  if (gradState.type==='radial') return `radial-gradient(circle at center, ${str})`;
  if (gradState.type==='conic')  return `conic-gradient(${gradState.dir||'from 0deg'}, ${str})`;
  return `linear-gradient(${gradState.dir}, ${str})`;
}
function renderGradient() {
  const css = buildGradientCss();
  document.getElementById('gradPreview').style.background = css;
  document.getElementById('gradCssBox').textContent = `background: ${css};\nbackground-image: ${css};`;
  renderGradStops();
}
function renderGradStops() {
  const el = document.getElementById('gradStops');
  el.innerHTML = '';
  gradState.stops.forEach((stop, i) => {
    const chip = document.createElement('div');
    chip.className = 'stop-chip' + (i===gradState.selectedStop?' selected':'');
    chip.style.background = stop.hex;
    chip.addEventListener('click', () => { gradState.selectedStop=i; updateStopControls(); renderGradStops(); });
    const rm = document.createElement('button');
    rm.className='stop-rm'; rm.textContent='×'; rm.title='Remove stop';
    rm.addEventListener('click', e => {
      e.stopPropagation();
      if (gradState.stops.length <= 2) return;
      gradState.stops.splice(i, 1);
      gradState.selectedStop = Math.min(gradState.selectedStop, gradState.stops.length-1);
      renderGradient();
    });
    chip.appendChild(rm);
    el.appendChild(chip);
  });
  const addBtn = document.createElement('button');
  addBtn.className='add-stop'; addBtn.textContent='+'; addBtn.title='Add color stop';
  addBtn.addEventListener('click', () => {
    // Find the largest gap between sorted stops and insert midpoint there
    const sorted = gradState.stops.slice().sort((a,b)=>a.pos-b.pos);
    let bestGap=0, insertPos=50;
    for (let i=0; i<sorted.length-1; i++) {
      const gap = sorted[i+1].pos - sorted[i].pos;
      if (gap > bestGap) { bestGap=gap; insertPos=Math.round((sorted[i].pos+sorted[i+1].pos)/2); }
    }
    gradState.stops.push({hex:'#ffffff', pos:insertPos});
    gradState.selectedStop = gradState.stops.length-1;
    updateStopControls(); renderGradient();
  });
  el.appendChild(addBtn);
}
function updateStopControls() {
  const stop = gradState.stops[gradState.selectedStop];
  if (!stop) return;
  document.getElementById('stopColorInp').value = stop.hex;
  document.getElementById('stopPosSlider').value = stop.pos;
  document.getElementById('stopPosVal').textContent = stop.pos;
}
function syncGradTypeBtns() {
  document.querySelectorAll('[data-gtype]').forEach(b =>
    b.className = 'btn bsm '+(b.dataset.gtype===gradState.type?'bp':'bg')
  );
  document.getElementById('dirSection').style.display = gradState.type==='conic'?'none':'block';
}

// ═══════════════════════════════════════════════════════════
// COLOR PICKER — ImageData wheel for performance
// ═══════════════════════════════════════════════════════════
let pickerHsl = {h:210, s:80, l:55};
let recentColors = [];
let wheelDragging = false;
let wheelRect = null;   // cached on dragstart only
let lastDrawnL = -1;    // avoid redrawing wheel when only hue/sat changes

function drawWheel() {
  const canvas = document.getElementById('colorWheel');
  const ctx = canvas.getContext('2d');
  const sz = canvas.width, cx = sz/2, cy = sz/2, radius = sz/2 - 2;
  const img = ctx.createImageData(sz, sz);
  const d = img.data;
  for (let y=0; y<sz; y++) {
    for (let x=0; x<sz; x++) {
      const dx=x-cx, dy=y-cy, dist=Math.sqrt(dx*dx+dy*dy);
      if (dist > radius) continue;
      const h = ((Math.atan2(dy,dx)*180/Math.PI)+90+360)%360;
      const s = (dist/radius)*100;
      const rgb = hslToRgb({h, s, l:pickerHsl.l});
      const idx = (y*sz+x)*4;
      d[idx]=rgb.r; d[idx+1]=rgb.g; d[idx+2]=rgb.b; d[idx+3]=255;
    }
  }
  ctx.putImageData(img, 0, 0);
  lastDrawnL = pickerHsl.l;
}

function updateWheelCursor() {
  const canvas = document.getElementById('colorWheel');
  const sz = canvas.width;
  const r = (sz/2-2)*(pickerHsl.s/100);
  const angle = (pickerHsl.h-90)*Math.PI/180;
  const cur = document.getElementById('wheelCursor');
  cur.style.left = (sz/2 + r*Math.cos(angle)) + 'px';
  cur.style.top  = (sz/2 + r*Math.sin(angle)) + 'px';
}

function updatePickerFromHsl() {
  if (Math.abs(pickerHsl.l - lastDrawnL) > 0.4) drawWheel();
  updateWheelCursor();
  const rgb = hslToRgb(pickerHsl);
  const hex = rgbToHex(rgb);
  document.getElementById('pickerPreview').style.background = hex;
  document.getElementById('pickerHexInp').value = hex;
  document.getElementById('hueSlider').value = Math.round(pickerHsl.h);
  document.getElementById('satSlider').value = Math.round(pickerHsl.s);
  document.getElementById('litSlider').value = Math.round(pickerHsl.l);
  document.getElementById('hueVal').textContent = Math.round(pickerHsl.h);
  document.getElementById('satVal').textContent = Math.round(pickerHsl.s);
  document.getElementById('litVal').textContent = Math.round(pickerHsl.l);
  document.getElementById('satTrack').style.background =
    `linear-gradient(to right,hsl(${pickerHsl.h},0%,${pickerHsl.l}%),hsl(${pickerHsl.h},100%,${pickerHsl.l}%))`;
  document.getElementById('litTrack').style.background =
    `linear-gradient(to right,hsl(${pickerHsl.h},${pickerHsl.s}%,0%),hsl(${pickerHsl.h},${pickerHsl.s}%,50%),hsl(${pickerHsl.h},${pickerHsl.s}%,100%))`;
  const hsv=rgbToHsv(rgb), cmyk=rgbToCmyk(rgb), lch=oklabToLch(rgbToOklab(rgb));
  document.getElementById('pickerInfo').innerHTML =
    `<div>Name: <b style="color:var(--t1)">${nearestName(rgb)}</b></div>
     <div>HEX: <b style="color:var(--t1)">${hex.toUpperCase()}</b></div>
     <div>RGB: <b style="color:var(--t1)">${rgb.r}, ${rgb.g}, ${rgb.b}</b></div>
     <div>HSV: <b style="color:var(--t1)">${Math.round(hsv.h)}° ${Math.round(hsv.s)}% ${Math.round(hsv.v)}%</b></div>
     <div>CMYK: <b style="color:var(--t1)">${cmyk.c}% ${cmyk.m}% ${cmyk.y}% ${cmyk.k}%</b></div>
     <div>Luminance: <b style="color:var(--t1)">${(luminance(rgb)*100).toFixed(1)}%</b></div>
     <div>OKLCH: <b style="color:var(--t1)">${lch.L.toFixed(1)}% ${(lch.C/100).toFixed(3)} ${Math.round(lch.H)}°</b></div>`;
}

function wheelHit(e) {
  const canvas = document.getElementById('colorWheel');
  // Use cached rect during drag; fresh rect on first hit
  const rect = wheelRect || (wheelRect = canvas.getBoundingClientRect());
  const cx = e.touches ? e.touches[0].clientX : e.clientX;
  const cy = e.touches ? e.touches[0].clientY : e.clientY;
  const x=cx-rect.left-canvas.width/2, y=cy-rect.top-canvas.height/2;
  const radius=canvas.width/2-2, dist=Math.sqrt(x*x+y*y);
  if (dist > radius) return;
  pickerHsl.h = ((Math.atan2(y,x)*180/Math.PI)+90+360)%360;
  pickerHsl.s = clamp((dist/radius)*100, 0, 100);
  updatePickerFromHsl();
}

function addToRecent(hex) {
  recentColors = recentColors.filter(x=>x!==hex);
  recentColors.unshift(hex);
  if (recentColors.length > 20) recentColors.pop();
  renderRecent();
}
function renderRecent() {
  const el = document.getElementById('recentSwatches');
  el.innerHTML = '';
  recentColors.forEach(hex => {
    const sw = document.createElement('div');
    sw.className = 'rswatch';
    sw.style.background = hex;
    sw.title = hex;
    sw.dataset.hex = hex;
    el.appendChild(sw);
  });
}

// ═══════════════════════════════════════════════════════════
// APP STATE
// ═══════════════════════════════════════════════════════════
let state = {mode:'analogous', count:6, seeds:[], slots:[], history:[]};
let extractedColors = [];
let tokenTab = 'css';
let expTab = 'hex';
let imgObjectUrl = null;

// ═══════════════════════════════════════════════════════════
// PALETTE RENDERING
// ═══════════════════════════════════════════════════════════
function cloneSlot(slot) {
  return { locked:slot.locked, color:{hex:slot.color.hex, rgb:{...slot.color.rgb}, hsl:{...slot.color.hsl}} };
}
function renderPalette() {
  const strip = document.getElementById('pstrip');
  strip.innerHTML = '';
  state.slots.forEach((slot, i) => {
    const tc=textColor(slot.color.rgb), name=nearestName(slot.color.rgb);
    const el = document.createElement('div');
    el.className='slot'; el.style.background=slot.color.hex;
    el.innerHTML=`<div class="sacts">
      <button class="sbtn${slot.locked?' locked':''}" data-act="lock" data-i="${i}" style="color:${slot.locked?'var(--acc)':tc}" title="${slot.locked?'Unlock':'Lock'}">${slot.locked?'🔒':'🔓'}</button>
      <button class="sbtn" data-act="copy" data-i="${i}" style="color:${tc}" title="Copy hex">📋</button>
    </div>
    <div class="sinfo">
      <div class="sname" style="color:${tc}">${name}</div>
      <div class="shex" data-act="copy" data-i="${i}" style="color:${tc}">${slot.color.hex.toUpperCase()}</div>
      <div class="shsl" style="color:${tc}">${Math.round(slot.color.hsl.h)}° ${Math.round(slot.color.hsl.s)}% ${Math.round(slot.color.hsl.l)}%</div>
    </div>`;
    strip.appendChild(el);
  });
  const psec=document.getElementById('prevSec'), ps=document.getElementById('prevStrip');
  if (state.slots.length) {
    psec.style.display='block';
    ps.innerHTML=state.slots.map(s=>`<div style="flex:1;background:${s.color.hex}"></div>`).join('');
  }
}
function renderHgrid() {
  document.getElementById('hgrid').innerHTML=HARMONIES.map(h=>
    `<button class="hbtn${state.mode===h.id?' on':''}" data-mode="${h.id}">${h.label}</button>`
  ).join('');
  document.getElementById('hdesc').textContent=HARMONIES.find(h=>h.id===state.mode)?.desc||'';
}
function renderSeeds() {
  document.getElementById('seedList').innerHTML=state.seeds.map((s,i)=>
    `<div class="seeditem"><div class="seedsw" style="background:${s.hex}"></div><span class="seedhex">${s.hex.toUpperCase()}</span><button class="seedrm" data-srm="${i}" title="Remove">×</button></div>`
  ).join('');
}
function renderThemes() {
  document.getElementById('themesGrid').innerHTML=THEMES.map((t,i)=>{
    const chips=t.seeds.slice(0,5).map(h=>`<div class="theme-chip" style="background:${h}"></div>`).join('');
    return `<div class="theme-card" data-theme="${i}" title="${t.name}"><div class="theme-strip">${chips}</div><div class="theme-label">${t.name}</div></div>`;
  }).join('');
}
function generate() {
  state.history.push(state.slots.map(cloneSlot));
  if (state.history.length > 25) state.history.shift();
  const seeds = state.seeds.map(s=>({...s.hsl}));
  const colors = genPalette(state.mode, state.count, seeds.length?seeds:null);
  state.slots = colors.map((color,i)=>{ const p=state.slots[i]; return (p&&p.locked)?p:{color,locked:false}; });
  renderPalette();
}
function undo() { if (!state.history.length) return; state.slots=state.history.pop(); renderPalette(); }
function showToast(el, msg) {
  el.querySelectorAll('.toast').forEach(t=>t.remove());
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  el.appendChild(t); setTimeout(()=>t.remove(), 1100);
}

// ═══════════════════════════════════════════════════════════
// SCALE RENDERING
// ═══════════════════════════════════════════════════════════
function renderScale(hex) {
  document.getElementById('scaleSwatch').style.background=hex;
  currentScale=generateScale(hex);
  const grid=document.getElementById('scaleGrid'); grid.innerHTML='';
  const row=document.createElement('div'); row.className='scale-row';
  currentScale.forEach(({step,hex:sh,rgb})=>{
    const tc=textColor(rgb), chip=document.createElement('div');
    chip.className='scale-chip'; chip.style.background=sh;
    chip.innerHTML=`<div class="scale-step-label" style="color:${tc}">${step}</div><div class="scale-hex-label" style="color:${tc}">${sh.toUpperCase()}</div>`;
    chip.title=`${step}: ${sh} — click to copy`;
    chip.addEventListener('click',()=>{ navigator.clipboard.writeText(sh).catch(()=>{}); showToast(chip,'Copied!'); });
    row.appendChild(chip);
  });
  grid.appendChild(row); renderTokens();
}
function renderTokens() {
  if (!currentScale.length) return;
  const name = currentScaleName;
  let out='';
  if (tokenTab==='css') out=`:root {\n`+currentScale.map(({step,hex})=>`  --${name}-${step}: ${hex};`).join('\n')+`\n}`;
  else if (tokenTab==='js') out=`export const ${name} = {\n`+currentScale.map(({step,hex})=>`  '${step}': '${hex}',`).join('\n')+`\n};`;
  else if (tokenTab==='tailwind') out=`// tailwind.config.js\ncolors: {\n  ${name}: {\n`+currentScale.map(({step,hex})=>`    '${step}': '${hex}',`).join('\n')+`\n  }\n}`;
  else if (tokenTab==='json') out=JSON.stringify({[name]:Object.fromEntries(currentScale.map(({step,hex})=>[step,hex]))},null,2);
  document.getElementById('tokenPre').textContent=out;
}

// ═══════════════════════════════════════════════════════════
// COLOR BLINDNESS RENDERING
// ═══════════════════════════════════════════════════════════
function renderSim() {
  const slots=state.slots;
  if (!slots.length) { document.getElementById('simTypes').innerHTML='<p style="color:var(--t3);font-size:12px;grid-column:1/-1;">Generate a palette first.</p>'; return; }
  document.getElementById('simTypes').innerHTML=CB_TYPES.map(cbType=>{
    const chips=slots.map(slot=>{
      const simRgb=simulateColor(slot.color.rgb,cbType), simHex=rgbToHex(simRgb), tc=textColor(simRgb);
      return `<div class="sim-chip" style="background:${simHex}"><span class="sim-chip-hex" style="color:${tc}">${simHex.toUpperCase()}</span></div>`;
    }).join('');
    return `<div class="sim-card"><div class="sim-card-hd"><div class="sim-card-title">${cbType.name}</div><div class="sim-card-sub">${cbType.desc}</div></div><div class="sim-strip">${chips}</div></div>`;
  }).join('');
}

// ═══════════════════════════════════════════════════════════
// ACCESSIBILITY RENDERING
// ═══════════════════════════════════════════════════════════
const BADGE_STYLES = {
  AAA:      'background:rgba(0,230,118,.18);color:#00e676',
  AA:       'background:rgba(105,240,174,.15);color:#69f0ae',
  'AA Large':'background:rgba(255,241,118,.12);color:#fff176',
  Fail:     'background:rgba(255,68,85,.15);color:#ff4455',
};
function badge(lv) { return `<span class="a11y-badge" style="${BADGE_STYLES[lv]}">${lv}</span>`; }

function renderA11y() {
  const slots=state.slots;
  if (!slots.length) { document.getElementById('a11yMatrix').innerHTML='<p style="color:var(--t3);font-size:12px;">Generate a palette first.</p>'; document.getElementById('a11yPairs').innerHTML=''; return; }
  let html=`<table style="width:100%;border-collapse:collapse;font-size:11px;"><thead><tr><th style="padding:8px;border:1px solid var(--b1);background:var(--s2);color:var(--t3);text-align:left;font-size:10px;">↓ on →</th>`;
  slots.forEach((_,i)=>{ html+=`<th style="padding:8px;border:1px solid var(--b1);background:var(--s2);text-align:center;font-size:10px;color:var(--t3);">${i+1}</th>`; });
  html+=`</tr></thead><tbody>`;
  slots.forEach((sa,i)=>{
    html+=`<tr><td style="padding:8px;border:1px solid var(--b1);"><span style="display:inline-block;width:10px;height:10px;background:${sa.color.hex};border-radius:2px;vertical-align:middle;margin-right:4px;border:1px solid rgba(255,255,255,.08)"></span><span style="font-size:10px;color:var(--t3)">${i+1}</span></td>`;
    slots.forEach((sb,j)=>{
      if (i===j) { html+=`<td style="padding:8px;border:1px solid var(--b1);text-align:center;background:var(--s2);color:var(--t3)">—</td>`; return; }
      const r=contrastRatio(sa.color.rgb,sb.color.rgb), lv=wcagLevel(r);
      html+=`<td style="padding:8px;border:1px solid var(--b1);text-align:center;">${badge(lv)}<br/><span style="font-size:10px;color:var(--t3)">${r.toFixed(1)}:1</span></td>`;
    });
    html+=`</tr>`;
  });
  html+=`</tbody></table>`;
  document.getElementById('a11yMatrix').innerHTML=html;
  const pairs=[];
  for (let i=0;i<slots.length;i++) for(let j=i+1;j<slots.length;j++) {
    const r=contrastRatio(slots[i].color.rgb,slots[j].color.rgb), lv=wcagLevel(r);
    if (lv!=='Fail') pairs.push({a:slots[i],b:slots[j],ratio:r,level:lv});
  }
  pairs.sort((a,b)=>b.ratio-a.ratio);
  document.getElementById('a11yPairs').innerHTML=pairs.slice(0,8).map(({a,b,ratio,level})=>`
    <div style="background:var(--s1);border:1px solid var(--b1);border-radius:3px;overflow:hidden;">
      <div style="height:64px;background:${a.color.hex};display:flex;align-items:center;justify-content:center;flex-direction:column;gap:3px;padding:8px;">
        <div style="font-family:var(--fd);font-size:14px;font-weight:700;color:${b.color.hex}">Aa Sample</div>
        <div style="font-size:10px;color:${b.color.hex};opacity:.8">Body text preview</div>
      </div>
      <div style="padding:8px 10px;display:flex;justify-content:space-between;align-items:center;">
        <div style="display:flex;gap:4px;">${[a,b].map(x=>`<div style="width:10px;height:10px;background:${x.color.hex};border-radius:2px;border:1px solid rgba(255,255,255,.08)"></div>`).join('')}</div>
        <span style="font-size:10px;color:var(--t3)">${ratio.toFixed(1)}:1</span>
        ${badge(level)}
      </div>
    </div>`).join('');
}

// ═══════════════════════════════════════════════════════════
// FORMAT CONVERTER
// ═══════════════════════════════════════════════════════════
function renderConverter(rgb) {
  document.getElementById('convSwatch').style.background=rgbToHex(rgb);
  const hex=rgbToHex(rgb), hsl=rgbToHsl(rgb), hsv=rgbToHsv(rgb), cmyk=rgbToCmyk(rgb);
  const oklab=rgbToOklab(rgb), lch=oklabToLch(oklab);
  function card(label,val,sub='') {
    const escaped=val.replace(/'/g,"\\'");
    return `<div class="conv-card"><div class="conv-label">${label}</div><div class="conv-val">${val}</div>${sub?`<div class="conv-sub">${sub}</div>`:''}<button class="conv-copy" data-copy="${escaped}">copy</button></div>`;
  }
  document.getElementById('convGrid').innerHTML=
    card('HEX',hex)+
    card('CSS RGB',`rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`,`R:${rgb.r} G:${rgb.g} B:${rgb.b}`)+
    card('CSS HSL',`hsl(${Math.round(hsl.h)}, ${Math.round(hsl.s)}%, ${Math.round(hsl.l)}%)`,`H:${Math.round(hsl.h)}° S:${Math.round(hsl.s)}% L:${Math.round(hsl.l)}%`)+
    card('HSV / HSB',`hsv(${Math.round(hsv.h)}, ${Math.round(hsv.s)}%, ${Math.round(hsv.v)}%)`,`H:${Math.round(hsv.h)}° S:${Math.round(hsv.s)}% V:${Math.round(hsv.v)}%`)+
    card('CMYK',`cmyk(${cmyk.c}%, ${cmyk.m}%, ${cmyk.y}%, ${cmyk.k}%)`,`C:${cmyk.c} M:${cmyk.m} Y:${cmyk.y} K:${cmyk.k}`)+
    card('OKLab',`oklab(${oklab.L.toFixed(3)}, ${oklab.a.toFixed(3)}, ${oklab.b.toFixed(3)})`)+
    card('OKLCH',`oklch(${lch.L.toFixed(1)}% ${(lch.C/100).toFixed(3)} ${Math.round(lch.H)})`,`L:${lch.L.toFixed(1)} C:${(lch.C/100).toFixed(3)} H:${Math.round(lch.H)}°`)+
    card('Nearest Name',nearestName(rgb));
}

// ═══════════════════════════════════════════════════════════
// IMAGE EXTRACTION — median-cut quantization
// ═══════════════════════════════════════════════════════════
function medianCut(px, depth) {
  if (depth===0||!px.length) return [px];
  let mnR=255,mxR=0,mnG=255,mxG=0,mnB=255,mxB=0;
  for (const {r,g,b} of px) { if(r<mnR)mnR=r; if(r>mxR)mxR=r; if(g<mnG)mnG=g; if(g>mxG)mxG=g; if(b<mnB)mnB=b; if(b>mxB)mxB=b; }
  const rR=mxR-mnR, gR=mxG-mnG, bR=mxB-mnB, mx=Math.max(rR,gR,bR);
  const key = mx===rR?'r':mx===gR?'g':'b';
  px.sort((a,b)=>a[key]-b[key]);
  const mid=Math.floor(px.length/2);
  return [...medianCut(px.slice(0,mid),depth-1), ...medianCut(px.slice(mid),depth-1)];
}
function avgBucket(b) {
  if (!b.length) return {r:128,g:128,b:128};
  const s=b.reduce((a,p)=>({r:a.r+p.r,g:a.g+p.g,b:a.b+p.b}),{r:0,g:0,b:0});
  return {r:Math.round(s.r/b.length),g:Math.round(s.g/b.length),b:Math.round(s.b/b.length)};
}
function isUsable(rgb) { const {s,l}=rgbToHsl(rgb); return s>=8&&l>=10&&l<=92; }
function dedupColors(cs, threshold=0.08) {
  const r=[]; for (const c of cs) if (!r.some(x=>colorDist(c,x)<threshold)) r.push(c); return r;
}
async function extractColors(file, count=8) {
  return new Promise((res,rej)=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(1,200/Math.max(img.width,img.height));
      const w=Math.max(1,Math.round(img.width*scale)), h=Math.max(1,Math.round(img.height*scale));
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      const data=c.getContext('2d').getImageData(0,0,w,h).data;
      const px=[];
      for (let i=0;i<data.length;i+=4) { if(data[i+3]<128) continue; px.push({r:data[i],g:data[i+1],b:data[i+2]}); }
      if (!px.length) return res([]);
      const depth=Math.ceil(Math.log2(count*2));
      const buckets=medianCut([...px],depth);
      const avgs=buckets.map(avgBucket).filter(isUsable);
      const dd=dedupColors(avgs);
      dd.sort((a,b)=>rgbToHsl(b).s-rgbToHsl(a).s);
      res(dd.slice(0,count));
    };
    img.onerror=rej;
    img.src=URL.createObjectURL(file);
  });
}

// ═══════════════════════════════════════════════════════════
// STORAGE & URL
// ═══════════════════════════════════════════════════════════
const LS_KEY='chroma:palettes';
function loadSaved() { try { return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); } catch { return []; } }
function savePalette(name,hexes,mode) {
  const saved=loadSaved();
  const e={id:crypto.randomUUID(),name,hexes,mode,createdAt:Date.now()};
  localStorage.setItem(LS_KEY,JSON.stringify([e,...saved].slice(0,50))); return e;
}
function deleteSaved(id) { localStorage.setItem(LS_KEY,JSON.stringify(loadSaved().filter(p=>p.id!==id))); }
function encodeUrl(hexes,mode) { return `${location.origin}${location.pathname}#p=${hexes.map(h=>h.replace('#','')).join('-')}&m=${mode}`; }
function decodeUrl() {
  try {
    const p=new URLSearchParams(location.hash.slice(1));
    const hexes=(p.get('p')||'').split('-').map(c=>'#'+c).filter(c=>/^#[0-9a-fA-F]{6}$/.test(c));
    const mode=p.get('m')||'analogous';
    return hexes.length>=2?{hexes,mode}:null;
  } catch { return null; }
}

// ═══════════════════════════════════════════════════════════
// SAVED VIEW
// ═══════════════════════════════════════════════════════════
function renderSaved() {
  const saved=loadSaved();
  document.getElementById('btnClearAll').style.display=saved.length?'inline-flex':'none';
  if (!saved.length) {
    document.getElementById('savedContent').innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--t3);"><div style="font-family:var(--fd);font-size:18px;font-weight:700;color:var(--t2);margin-bottom:8px;">No saved palettes yet</div><p style="font-size:12px;">Generate a palette you love, then click ♡ to save it.</p></div>';
    return;
  }
  document.getElementById('savedContent').innerHTML=`<div class="saved-grid">${saved.map(p=>`
    <div class="saved-card">
      <div style="height:44px;display:flex;">${p.hexes.map(h=>`<div style="flex:1;background:${h}"></div>`).join('')}</div>
      <div style="padding:10px 12px;">
        <div style="font-family:var(--fd);font-size:13px;font-weight:700;margin-bottom:2px;">${p.name||'Unnamed'}</div>
        <div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">${p.mode} · ${p.hexes.length} colors</div>
        <div style="display:flex;gap:5px;">
          <button class="btn bg bsm" data-load="${p.id}">↓ Load</button>
          <button class="btn bg bsm" data-share-saved="${p.id}">⤴ Share</button>
          <button class="btn bd bsm" data-del="${p.id}">× Del</button>
        </div>
      </div>
    </div>`).join('')}</div>`;
}

// ═══════════════════════════════════════════════════════════
// EXPORT MODAL
// ═══════════════════════════════════════════════════════════
function renderExpContent() {
  const hexes=state.slots.map(s=>s.color.hex);
  let c='';
  if (expTab==='hex') c=hexes.join('\n');
  else if (expTab==='css') c=`:root {\n${hexes.map((h,i)=>`  --color-${i+1}: ${h};`).join('\n')}\n}`;
  else if (expTab==='array') c=`const palette = [\n${hexes.map(h=>`  '${h}'`).join(',\n')}\n];`;
  else if (expTab==='scss') c=hexes.map((h,i)=>`$color-${i+1}: ${h};`).join('\n');
  document.getElementById('expContent').textContent=c;
  document.getElementById('expSwatch').innerHTML=hexes.map(h=>`<div style="flex:1;background:${h}"></div>`).join('');
}

// ═══════════════════════════════════════════════════════════
// VIEW SWITCHING
// ═══════════════════════════════════════════════════════════
const VIEW_IDS = {pal:'vpal',pick:'vpick',scale:'vscale',sim:'vsim',grad:'vgrad',conv:'vconv',a11y:'va11y',img:'vimg',saved:'vsaved'};
function switchView(name) {
  Object.values(VIEW_IDS).forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; });
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  const el=document.getElementById(VIEW_IDS[name]);
  if (el) el.style.display='flex';
  document.querySelectorAll(`.nb[data-view="${name}"]`).forEach(b=>b.classList.add('on'));
  // Per-view init
  if (name==='a11y') renderA11y();
  if (name==='saved') renderSaved();
  if (name==='sim') renderSim();
  if (name==='pick') { if (lastDrawnL===-1) drawWheel(); updatePickerFromHsl(); }
  if (name==='grad') renderGradient();
}
// Views that need block/flex carefully — fix non-flex views
['vsim','vimg','vconv','va11y','vsaved'].forEach(id=>{
  const el=document.getElementById(id);
  if (el) el.style.display='none';
});

// ═══════════════════════════════════════════════════════════
// MODAL HELPERS
// ═══════════════════════════════════════════════════════════
function openModal(id) { document.getElementById(id).style.display='flex'; }
function closeModal(id) { document.getElementById(id).style.display='none'; }
function closeAllModals() { ['modalExport','modalShare','modalSave'].forEach(closeModal); }

// ═══════════════════════════════════════════════════════════
// EVENT WIRING
// ═══════════════════════════════════════════════════════════

// Nav
document.querySelector('.nav').addEventListener('click', e=>{
  const b=e.target.closest('[data-view]'); if(b) switchView(b.dataset.view);
});

// Header buttons
document.getElementById('btnGen').addEventListener('click', generate);
document.getElementById('btnUndo').addEventListener('click', undo);
document.getElementById('btnExport').addEventListener('click', ()=>{ renderExpContent(); openModal('modalExport'); });
document.getElementById('btnShare').addEventListener('click', ()=>{
  const hexes=state.slots.map(s=>s.color.hex);
  document.getElementById('shareUrl').value=encodeUrl(hexes,state.mode);
  document.getElementById('shareSwatch').innerHTML=hexes.map(h=>`<div style="flex:1;background:${h}"></div>`).join('');
  openModal('modalShare');
});
document.getElementById('btnSave').addEventListener('click', ()=>{
  document.getElementById('saveSwatch').innerHTML=state.slots.map(s=>`<div style="flex:1;background:${s.color.hex}"></div>`).join('');
  document.getElementById('saveNameInp').value='';
  openModal('modalSave');
  setTimeout(()=>document.getElementById('saveNameInp').focus(), 50);
});

// Palette strip — lock + copy via delegation
document.getElementById('pstrip').addEventListener('click', e=>{
  const btn=e.target.closest('[data-act]'); if(!btn) return;
  const i=parseInt(btn.dataset.i);
  if (btn.dataset.act==='lock') { state.slots[i].locked=!state.slots[i].locked; renderPalette(); }
  else if (btn.dataset.act==='copy') {
    navigator.clipboard.writeText(state.slots[i].color.hex).catch(()=>{});
    showToast(document.querySelectorAll('.slot')[i], 'Copied!');
  }
});

// Harmony grid
document.getElementById('hgrid').addEventListener('click', e=>{
  const b=e.target.closest('[data-mode]'); if(!b) return;
  state.mode=b.dataset.mode; renderHgrid(); generate();
});

// Count slider
document.getElementById('countRange').addEventListener('input', e=>{
  state.count=+e.target.value; document.getElementById('countNum').textContent=state.count; generate();
});

// Seeds
function addSeed() {
  const inp=document.getElementById('seedInp'), hex=parseHex(inp.value);
  if (!hex) { inp.classList.add('err'); setTimeout(()=>inp.classList.remove('err'),600); return; }
  const rgb=hexToRgb(hex), hsl=rgbToHsl(rgb);
  state.seeds.push({hex,rgb,hsl}); inp.value=''; renderSeeds();
}
document.getElementById('btnAddSeed').addEventListener('click', addSeed);
document.getElementById('seedInp').addEventListener('keydown', e=>{ if(e.key==='Enter') addSeed(); });
document.getElementById('seedList').addEventListener('click', e=>{
  const b=e.target.closest('[data-srm]'); if(!b) return;
  state.seeds.splice(+b.dataset.srm,1); renderSeeds();
});

// Themes
document.getElementById('themesGrid').addEventListener('click', e=>{
  const card=e.target.closest('[data-theme]'); if(!card) return;
  const t=THEMES[+card.dataset.theme];
  state.mode=t.mode;
  state.seeds=t.seeds.map(h=>{ const rgb=hexToRgb(h); return {hex:h.toLowerCase(),rgb,hsl:rgbToHsl(rgb)}; });
  renderSeeds(); renderHgrid(); generate();
});

// Color Picker — wheel
const wheelCanvas = document.getElementById('colorWheel');
wheelCanvas.addEventListener('mousedown', e=>{ wheelDragging=true; wheelRect=wheelCanvas.getBoundingClientRect(); wheelHit(e); });
wheelCanvas.addEventListener('touchstart', e=>{ e.preventDefault(); wheelDragging=true; wheelRect=wheelCanvas.getBoundingClientRect(); wheelHit(e); }, {passive:false});
document.addEventListener('mousemove',  e=>{ if(wheelDragging) wheelHit(e); });
document.addEventListener('touchmove',  e=>{ if(wheelDragging) { e.preventDefault(); wheelHit(e); } }, {passive:false});
document.addEventListener('mouseup',  ()=>{ if(wheelDragging){ wheelDragging=false; wheelRect=null; } });
document.addEventListener('touchend', ()=>{ if(wheelDragging){ wheelDragging=false; wheelRect=null; } });

// Picker sliders
document.getElementById('hueSlider').addEventListener('input', e=>{ pickerHsl.h=+e.target.value; updatePickerFromHsl(); });
document.getElementById('satSlider').addEventListener('input', e=>{ pickerHsl.s=+e.target.value; updatePickerFromHsl(); });
document.getElementById('litSlider').addEventListener('input', e=>{ pickerHsl.l=+e.target.value; updatePickerFromHsl(); });
document.getElementById('pickerHexInp').addEventListener('input', e=>{
  const hex=parseHex(e.target.value); if(hex){ pickerHsl=rgbToHsl(hexToRgb(hex)); updatePickerFromHsl(); }
});
document.getElementById('btnPickerUseSeed').addEventListener('click', ()=>{
  const ph=parseHex(document.getElementById('pickerHexInp').value); if(!ph) return;
  const rgb=hexToRgb(ph); state.seeds=[{hex:ph,rgb,hsl:rgbToHsl(rgb)}];
  addToRecent(ph); renderSeeds(); switchView('pal'); generate();
});
document.getElementById('btnPickerAdd').addEventListener('click', ()=>{
  const ph=parseHex(document.getElementById('pickerHexInp').value); if(!ph) return;
  const rgb=hexToRgb(ph), color={hex:ph,rgb,hsl:rgbToHsl(rgb)};
  state.slots.push({color,locked:false}); addToRecent(ph); renderPalette();
});
// Recent swatches — delegated, no inline onclick
document.getElementById('recentSwatches').addEventListener('click', e=>{
  const sw=e.target.closest('[data-hex]'); if(!sw) return;
  pickerHsl=rgbToHsl(hexToRgb(sw.dataset.hex)); updatePickerFromHsl();
});

// Scale
document.getElementById('scaleInp').addEventListener('input', e=>{ const h=parseHex(e.target.value); if(h) renderScale(h); });
document.getElementById('scaleNameInp').addEventListener('input', e=>{ currentScaleName=e.target.value.trim()||'primary'; renderTokens(); });
document.getElementById('btnGenScale').addEventListener('click', ()=>{
  const h=parseHex(document.getElementById('scaleInp').value);
  if (h) renderScale(h);
  else if (state.slots.length) { const h2=state.slots[0].color.hex; document.getElementById('scaleInp').value=h2; renderScale(h2); }
});
document.getElementById('tokenTabRow').addEventListener('click', e=>{
  const b=e.target.closest('[data-ttab]'); if(!b) return;
  tokenTab=b.dataset.ttab;
  document.querySelectorAll('[data-ttab]').forEach(x=>x.className='btn bsm '+(x.dataset.ttab===tokenTab?'bp':'bg'));
  renderTokens();
});
document.getElementById('btnCopyTokens').addEventListener('click', ()=>{
  navigator.clipboard.writeText(document.getElementById('tokenPre').textContent).catch(()=>{});
  const btn=document.getElementById('btnCopyTokens'); btn.textContent='✓ Copied'; setTimeout(()=>btn.textContent='Copy',1400);
});
document.getElementById('btnScaleToSeeds').addEventListener('click', ()=>{
  if (!currentScale.length) return;
  const picks=[1,3,5,7,9].map(i=>currentScale[i]).filter(Boolean);
  state.seeds=picks.map(({hex,rgb,hsl})=>({hex,rgb,hsl}));
  renderSeeds(); switchView('pal'); generate();
});

// Gradient — type buttons
document.getElementById('gtypeBtns').addEventListener('click', e=>{
  const b=e.target.closest('[data-gtype]'); if(!b) return;
  gradState.type=b.dataset.gtype; syncGradTypeBtns(); renderGradient();
});
// Direction buttons
document.getElementById('dirBtns').addEventListener('click', e=>{
  const b=e.target.closest('[data-dir]'); if(!b) return;
  gradState.dir=b.dataset.dir;
  document.querySelectorAll('[data-dir]').forEach(x=>x.className='btn bsm '+(x.dataset.dir===gradState.dir?'bp':'bg'));
  renderGradient();
});
document.getElementById('stopColorInp').addEventListener('input', e=>{
  const h=parseHex(e.target.value); if(h){ gradState.stops[gradState.selectedStop].hex=h; renderGradient(); }
});
document.getElementById('stopPosSlider').addEventListener('input', e=>{
  gradState.stops[gradState.selectedStop].pos=+e.target.value;
  document.getElementById('stopPosVal').textContent=e.target.value;
  renderGradient();
});
document.getElementById('btnCopyGrad').addEventListener('click', ()=>{
  navigator.clipboard.writeText(`background: ${buildGradientCss()};`).catch(()=>{});
  const btn=document.getElementById('btnCopyGrad'); btn.textContent='✓ Copied'; setTimeout(()=>btn.textContent='Copy CSS',1400);
});
document.getElementById('btnLoadPaletteToGrad').addEventListener('click', ()=>{
  if (!state.slots.length) return;
  const n=state.slots.length;
  gradState.stops=state.slots.map((slot,i)=>({hex:slot.color.hex, pos:Math.round(i/(n-1||1)*100)}));
  gradState.selectedStop=0; updateStopControls(); renderGradient();
});
// Gradient presets — rendered by JS, delegated
document.getElementById('gradPresets').addEventListener('click', e=>{
  const b=e.target.closest('[data-gpreset]'); if(!b) return;
  const p=GRAD_PRESETS[+b.dataset.gpreset];
  gradState={...gradState, ...p, stops:p.stops.map(s=>({...s}))};
  gradState.selectedStop=0; syncGradTypeBtns(); updateStopControls(); renderGradient();
});

// Converter — event delegation for copy buttons
document.getElementById('convGrid').addEventListener('click', e=>{
  const btn=e.target.closest('[data-copy]'); if(!btn) return;
  navigator.clipboard.writeText(btn.dataset.copy).catch(()=>{});
  btn.textContent='✓'; setTimeout(()=>btn.textContent='copy',1200);
});
document.getElementById('convInp').addEventListener('input', e=>{
  const rgb=parseAny(e.target.value); if(rgb) renderConverter(rgb);
});

// Export modal tabs
document.getElementById('expTabs').addEventListener('click', e=>{
  const b=e.target.closest('[data-tab]'); if(!b) return;
  expTab=b.dataset.tab;
  document.querySelectorAll('#expTabs [data-tab]').forEach(x=>x.className='btn bsm '+(x.dataset.tab===expTab?'bp':'bg'));
  renderExpContent();
});
document.getElementById('btnCopyExp').addEventListener('click', ()=>{
  navigator.clipboard.writeText(document.getElementById('expContent').textContent).catch(()=>{});
  const btn=document.getElementById('btnCopyExp'); btn.textContent='✓ Copied'; setTimeout(()=>btn.textContent='Copy',1400);
});
document.getElementById('btnCopyUrl').addEventListener('click', ()=>{
  navigator.clipboard.writeText(document.getElementById('shareUrl').value).catch(()=>{});
  const btn=document.getElementById('btnCopyUrl'); btn.textContent='✓ Copied'; setTimeout(()=>btn.textContent='Copy URL',1400);
});
document.getElementById('btnConfirmSave').addEventListener('click', ()=>{
  savePalette(document.getElementById('saveNameInp').value.trim()||'Unnamed', state.slots.map(s=>s.color.hex), state.mode);
  closeModal('modalSave');
});
document.getElementById('saveNameInp').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('btnConfirmSave').click(); });

// Modal close — data-close buttons + backdrop click
document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click',()=>closeModal(b.dataset.close)));
document.querySelectorAll('.overlay').forEach(el=>el.addEventListener('click',e=>{ if(e.target===el) closeAllModals(); }));

// Saved view actions — delegation
document.getElementById('savedContent').addEventListener('click', e=>{
  const load=e.target.closest('[data-load]');
  if (load) {
    const p=loadSaved().find(x=>x.id===load.dataset.load); if(!p) return;
    state.mode=p.mode;
    state.history.push(state.slots.map(cloneSlot));
    state.slots=p.hexes.map(hex=>{ const rgb=hexToRgb(hex); return {color:{hex,rgb,hsl:rgbToHsl(rgb)},locked:false}; });
    state.count=p.hexes.length;
    document.getElementById('countRange').value=state.count;
    document.getElementById('countNum').textContent=state.count;
    renderHgrid(); renderPalette(); switchView('pal'); return;
  }
  const del=e.target.closest('[data-del]');
  if (del) { if(!confirm('Delete this palette?')) return; deleteSaved(del.dataset.del); renderSaved(); return; }
  const sh=e.target.closest('[data-share-saved]');
  if (sh) {
    const p=loadSaved().find(x=>x.id===sh.dataset.shareSaved); if(!p) return;
    document.getElementById('shareUrl').value=encodeUrl(p.hexes,p.mode);
    document.getElementById('shareSwatch').innerHTML=p.hexes.map(h=>`<div style="flex:1;background:${h}"></div>`).join('');
    openModal('modalShare');
  }
});
document.getElementById('btnClearAll').addEventListener('click', ()=>{
  if (!confirm('Clear all saved palettes?')) return;
  localStorage.removeItem(LS_KEY); renderSaved();
});

// Image extraction
const dropZone=document.getElementById('dropZone');
document.getElementById('imgFile').addEventListener('change', e=>{ if(e.target.files[0]) handleImage(e.target.files[0]); });
dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', ()=>dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e=>{
  e.preventDefault(); dropZone.classList.remove('dragover');
  if (e.dataTransfer.files[0]) handleImage(e.dataTransfer.files[0]);
});
async function handleImage(file) {
  // Revoke previous object URL to prevent memory leak
  if (imgObjectUrl) { URL.revokeObjectURL(imgObjectUrl); imgObjectUrl=null; }
  imgObjectUrl=URL.createObjectURL(file);
  document.getElementById('imgPreview').src=imgObjectUrl;
  const row=document.getElementById('imgPreviewRow');
  row.style.display='flex';
  document.getElementById('imgColorsGrid').innerHTML='<p style="color:var(--t3);font-size:12px;">Extracting colors…</p>';
  try {
    extractedColors=await extractColors(file,8);
    document.getElementById('imgColorsGrid').innerHTML=extractedColors.map((rgb,idx)=>{
      const hex=rgbToHex(rgb);
      return `<div style="display:flex;align-items:center;gap:8px;" data-img-color="${idx}">
        <div style="width:32px;height:32px;border-radius:3px;background:${hex};border:1px solid rgba(255,255,255,.08);flex-shrink:0;cursor:pointer;" title="Click to use" data-use-one="${idx}"></div>
        <div style="flex:1;">
          <div style="font-family:var(--fm);font-size:11px;font-weight:700;text-transform:uppercase;">${hex.toUpperCase()}</div>
          <div style="font-size:10px;color:var(--t3);">${nearestName(rgb)}</div>
        </div>
        <button class="btn bg bsm" data-use-one="${idx}">Use</button>
      </div>`;
    }).join('');
  } catch {
    document.getElementById('imgColorsGrid').innerHTML='<p style="color:var(--danger);font-size:12px;">Extraction failed. Try another image.</p>';
  }
}
// Delegated handler for individual color use — replaces window.useSingleColor global
document.getElementById('imgColorsGrid').addEventListener('click', e=>{
  const btn=e.target.closest('[data-use-one]'); if(!btn) return;
  const rgb=extractedColors[+btn.dataset.useOne]; if(!rgb) return;
  const hex=rgbToHex(rgb);
  state.seeds=[{hex,rgb,hsl:rgbToHsl(rgb)}];
  renderSeeds(); switchView('pal'); generate();
});
document.getElementById('btnUseExtracted').addEventListener('click', ()=>{
  if (!extractedColors.length) return;
  state.seeds=extractedColors.slice(0,5).map(rgb=>({hex:rgbToHex(rgb),rgb,hsl:rgbToHsl(rgb)}));
  renderSeeds(); switchView('pal'); generate();
});

// Keyboard shortcuts
window.addEventListener('keydown', e=>{
  if (e.key==='Escape') { closeAllModals(); return; }
  if (e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
  if (e.code==='Space') { e.preventDefault(); generate(); }
  if ((e.ctrlKey||e.metaKey)&&e.key==='z') { e.preventDefault(); undo(); }
});

// ═══════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════
renderHgrid();
renderSeeds();
renderThemes();

// Gradient presets list
document.getElementById('gradPresets').innerHTML=GRAD_PRESETS.map((p,i)=>
  `<button class="btn bg bsm" data-gpreset="${i}" style="text-align:left;justify-content:flex-start;">${p.name}</button>`
).join('');
updateStopControls();
renderGradient();

// Scale & converter defaults
renderScale('#6366f1');
document.getElementById('scaleInp').value='#6366f1';
renderConverter(hexToRgb('#e07a5f'));
document.getElementById('convInp').value='#e07a5f';

// Load from URL hash or generate fresh
const fromUrl=decodeUrl();
if (fromUrl && fromUrl.hexes.length>=2) {
  state.mode=fromUrl.mode;
  state.slots=fromUrl.hexes.map(hex=>{ const rgb=hexToRgb(hex); return {color:{hex,rgb,hsl:rgbToHsl(rgb)},locked:false}; });
  state.count=fromUrl.hexes.length;
  document.getElementById('countRange').value=state.count;
  document.getElementById('countNum').textContent=state.count;
  renderHgrid(); renderPalette();
} else {
  generate();
}
</script>
</body>
</html>
